import{B as e,Q as t,s as n,z as r}from"./chunks/framework.C7gQUmET.js";const i=JSON.parse(`{"title":"SSR 与兼容","description":"","frontmatter":{},"headers":[],"relativePath":"guide/ssr.md","filePath":"guide/ssr.md","lastUpdated":null}`);var a={name:`guide/ssr.md`};function o(n,i,a,o,s,c){return t(),r(`div`,null,[...i[0]||=[e(`<h1 id="ssr-与兼容" tabindex="-1">SSR 与兼容 <a class="header-anchor" href="#ssr-与兼容" aria-label="Permalink to &quot;SSR 与兼容&quot;">​</a></h1><p>本节聚焦服务端渲染（SSR）支持、首屏体验优化、以及浏览器兼容策略，帮助你在 PC / 移动端 / 大屏场景保持一致的响应式表现。</p><h2 id="ssr-初始注入" tabindex="-1">SSR 初始注入 <a class="header-anchor" href="#ssr-初始注入" aria-label="Permalink to &quot;SSR 初始注入&quot;">​</a></h2><p><code>createResponsiveManager</code> 支持在服务端计算好缩放参数，并注入 <code>initialSnapshot</code>：</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// server.ts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { createResponsiveManager } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;@tlgf/responsive/core&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> render</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">url</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> manager</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createResponsiveManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    designWidth: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1440</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    initialSnapshot: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      viewportWidth: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1440</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      breakpoint: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;lg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      scale: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      fontScale: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    suppressInitialDomWrite: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    skipInitialUpdate: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> snapshot</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> manager.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    html: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">renderToString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* app */</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    state: snapshot,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>在客户端 hydration 时使用 <code>initialSnapshot</code>：</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> app</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createApp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(App);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">app.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">use</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createResponsivePlugin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  initialSnapshot: window.__RESPONSIVE_SNAPSHOT__,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  suppressInitialDomWrite: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">app.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;#app&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p>随后在首帧或图片加载完成后调用 <code>flushDom()</code>，一次性写入 CSS 变量：</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> manager</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useResponsiveManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">manager.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">flushDom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div><h2 id="首帧优化清单" tabindex="-1">首帧优化清单 <a class="header-anchor" href="#首帧优化清单" aria-label="Permalink to &quot;首帧优化清单&quot;">​</a></h2><ul><li><code>suppressInitialDomWrite: true</code>：避免 SSR 与 CSR 双写造成闪烁</li><li><code>skipInitialUpdate: true</code>：在客户端透传服务端快照，待布局稳定后再更新</li><li><code>pre-render CSS 变量</code>：服务端根据 <code>initialSnapshot</code> 将 <code>style=&quot;--rs-scale:1;...&quot;</code> 写入 <code>&lt;body&gt;</code> 或容器</li></ul><h2 id="polyfill-策略" tabindex="-1">Polyfill 策略 <a class="header-anchor" href="#polyfill-策略" aria-label="Permalink to &quot;Polyfill 策略&quot;">​</a></h2><p><code>ensureResponsivePolyfills()</code> 自动加载必要 polyfill：</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { ensureResponsivePolyfills } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;@tlgf/responsive&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ensureResponsivePolyfills</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ smoothScroll: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span></code></pre></div><table tabindex="0"><thead><tr><th>能力</th><th>默认支持</th><th>Polyfill 包</th><th>备注</th></tr></thead><tbody><tr><td>ResizeObserver</td><td>Chrome 64 / Safari 13</td><td><code>@juggle/resize-observer</code></td><td>Masonry 布局与容器缩放依赖</td></tr><tr><td>IntersectionObserver</td><td>Chrome 51 / Safari 12</td><td><code>intersection-observer</code></td><td>懒加载与曝光统计</td></tr><tr><td>requestAnimationFrame</td><td>Chrome 4 / Safari 6</td><td>内建降级</td><td>旧环境自动 fallback</td></tr><tr><td>Smooth Scroll</td><td>Chrome 61 / Safari 15</td><td><code>smoothscroll-polyfill</code></td><td>可选，配合 <code>scrollToItem</code></td></tr></tbody></table><h2 id="多端兼容要点" tabindex="-1">多端兼容要点 <a class="header-anchor" href="#多端兼容要点" aria-label="Permalink to &quot;多端兼容要点&quot;">​</a></h2><h3 id="pc-多窗口" tabindex="-1">PC / 多窗口 <a class="header-anchor" href="#pc-多窗口" aria-label="Permalink to &quot;PC / 多窗口&quot;">​</a></h3><ul><li><code>designWidth</code> 推荐 1440 或 1280</li><li>结合 <code>ResponsiveGrid</code> + <code>columnWeights</code> 实现不等宽列</li><li><code>preserveScroll</code> 应对多 Tab 切换或 KeepAlive</li></ul><h3 id="移动端-h5-webview" tabindex="-1">移动端 (H5 / WebView) <a class="header-anchor" href="#移动端-h5-webview" aria-label="Permalink to &quot;移动端 (H5 / WebView)&quot;">​</a></h3><ul><li>设置 <code>meta viewport</code> 与 <code>minScale</code></li><li>@media 结合 <code>--rs-breakpoint</code> 精细控制字体</li><li>Polyfill <code>IntersectionObserver</code> 提升懒加载兼容性</li></ul><h3 id="大屏-看板" tabindex="-1">大屏 / 看板 <a class="header-anchor" href="#大屏-看板" aria-label="Permalink to &quot;大屏 / 看板&quot;">​</a></h3><ul><li>服务端预计算 <code>initialSnapshot.viewportWidth = 1920</code></li><li>确定 <code>fontScale</code>，避免展示太小</li><li><code>destroyInvisible</code> 慎用，保持动画连续性</li></ul><h2 id="多实例管理" tabindex="-1">多实例管理 <a class="header-anchor" href="#多实例管理" aria-label="Permalink to &quot;多实例管理&quot;">​</a></h2><p>可在同页面内创建多个 <code>ResponsiveContainer</code>，为不同区域提供独立 runtime：</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> managerA</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createResponsiveManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ designWidth: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1440</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> managerB</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createResponsiveManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ designWidth: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">720</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span></code></pre></div><p>Vue 中通过 <code>provide</code> 注入：</p><div class="language-vue vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">vue</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">ResponsiveContainer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">manager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">managerA</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;Header /&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">ResponsiveContainer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">ResponsiveContainer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">manager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">managerB</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;Sidebar /&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">ResponsiveContainer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre></div><h2 id="troubleshooting" tabindex="-1">Troubleshooting <a class="header-anchor" href="#troubleshooting" aria-label="Permalink to &quot;Troubleshooting&quot;">​</a></h2><table tabindex="0"><thead><tr><th>问题</th><th>排查思路</th></tr></thead><tbody><tr><td>首帧闪动</td><td>确认服务端注入了快照并调用 <code>suppressInitialDomWrite</code></td></tr><tr><td>Polyfill 未生效</td><td>确认 <code>ensureResponsivePolyfills</code> 在入口最先执行，且 bundler 支持动态 import</td></tr><tr><td>Vue 2 兼容报错</td><td>确认安装 <code>vue-demi</code> + <code>@vue/composition-api</code>，并在构建里避免排除它们</td></tr><tr><td>React SSR hydration warning</td><td>确保 <code>ResponsiveProvider</code> 的 <code>options.initialSnapshot</code> 与服务端一致</td></tr></tbody></table><p>配合性能章节中的调优方法，可以进一步观察首屏渲染时间与虚拟滚动成本。</p>`,30)]])}var s=n(a,[[`render`,o]]);export{i as __pageData,s as default};